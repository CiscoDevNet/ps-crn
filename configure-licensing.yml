- name: Configure licensing
  hosts: firewall:&virl_hosts
  gather_facts: no
  connection: network_cli
  vars:
    licensing:
      token: ZjFkNzAzNmMtMmI3Ni00OTA3LTlhNTktMjgzODA4YTQyODMxLTE1ODYzMTQ5%0AMDEwMTN8MzZDaUNFczB4Z3hpbTI0M0hPUUUxckNpZFprZnpVZ2lNTUErdEk0%0Acmxxbz0%3D%0A
  tasks:
    - name: check license status
      cli_command:
        command: show license status
      register: initial_check

    - block:
      - name: Update certificates
        cli_command:
          command: crypto ca trustpool import url http://www.cisco.com/security/pki/trs/ios_core.p7b

      - name: Register to smart account
        cli_command:
          command: "license smart register idtoken {{ licensing.token }}"

      - name: Save configuration
        asa_config:
          save: yes

      - name: Waiting for successful registration
        cli_command:
          command: show license status
        register: license_status
        until: "'AUTHORIZED' in license_status.stdout|default(False)"
        retries: 60
        delay: 10
      when: initial_check.stdout is not search("AUTHORIZED")